<!DOCTYPE html>
<html>
<head>
    <title>Visor Geográfico Mejorado</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ESTILOS Y LIBRERÍAS (CSS y JavaScript) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.min.js"></script>

    <!-- Estilos personalizados para la página -->
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-panel {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            max-width: 270px;
        }
        .info-panel input {
            width: 250px;
            padding: 5px;
            margin-bottom: 5px;
        }
        .info-panel button {
            width: 100%;
            padding: 8px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 5px;
        }
        .info-panel button:hover {
            background-color: #0056b3;
        }
        .leaflet-top.leaflet-right {
            top: 10px;
        }
        /* Estilo para indicar una capa que falló al cargar */
        .layer-error-label {
            text-decoration: line-through;
            color: #999;
        }
        .layer-error-label:after {
            content: " (Error)";
            color: red;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div class="info-panel">
        <input type="text" id="buscador" placeholder="Buscar en todos los campos de los puntos...">
        <button id="descargarKML">Descargar Puntos Visibles (KML)</button>
    </div>

    <div id="map"></div>

    <script>
        // 1. INICIALIZACIÓN DEL MAPA Y CAPAS BASE
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' });
        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © <a href="https://www.esri.com/">Esri</a>' });
        var hibrido = L.layerGroup([
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { attribution: '© <a href="https://carto.com/attributions">CARTO</a>', pane: 'shadowPane' })
        ]);
        var baseMaps = { "Calles": osm, "Satélite": satelite, "Híbrido": hibrido };
        var map = L.map('map', { center: [-31.41, -64.18], zoom: 13, layers: [osm] }); // Centrado en Córdoba, Arg.
        map.createPane('shadowPane').style.zIndex = 650;

        // 2. INICIALIZACIÓN DE HERRAMIENTAS
        L.control.measure({ position: 'topright', primaryLengthUnit: 'meters', secondaryLengthUnit: 'kilometers', primaryAreaUnit: 'sqmeters', secondaryAreaUnit: 'hectares', activeColor: '#db4a39', completedColor: '#ff5e4d', localization: 'es' }).addTo(map);

        // 3. CARGA DE DATOS Y CONTROL DE CAPAS
        const todosLosMarcadores = [];
        const layerGroupPuntos = L.layerGroup().addTo(map);
        var overlayMaps = { "Puntos (Cuentas)": layerGroupPuntos };

        // --- Cargar Puntos desde Google Sheets (CSV) ---
        const urlsSheets = [
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vTkDyVDpow7TJAolEUXcWVW9I-5ntVxnJbTdVClWQpP5bPSkbXlfFdUjytdtWWqyUT1qXiM_a6T4u9Y/pub?gid=0&single=true&output=csv',
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4fd4H6m1wrYei8KWqjCZEavtRrPph5Z1dXZkhC67pj_cCDk5WCrSUYAVPg59JNKvvQXrYK8b8u-Wj/pub?gid=0&single=true&output=csv'
        ];
        urlsSheets.forEach(url => {
            Papa.parse(url, {
                download: true, header: true,
                complete: function(results) {
                    results.data.forEach(punto => {
                        if (punto.latitud && punto.longitud) {
                            const lat = parseFloat(String(punto.latitud).replace(',', '.'));
                            const lon = parseFloat(String(punto.longitud).replace(',', '.'));
                            const marker = L.marker([lat, lon]);
                            marker.datos = punto;
                            let popupContent = `<b>Número de Cuenta:</b> ${punto['Número de Cuenta'] || ''}<br><b>Nomenclatura Castral:</b> ${punto['Nomenclatura Castral'] || ''}<br><b>Nomenclatura Oficial:</b> ${punto['Nomenclatura Oficial'] || ''}<br><b>Carpeta Interna:</b> ${punto['Carpeta Interna'] || ''}<br><b>Observaciones:</b> ${punto.observaciones || ''}`;
                            marker.bindPopup(popupContent);
                            todosLosMarcadores.push(marker);
                            layerGroupPuntos.addLayer(marker);
                        }
                    });
                }
            });
        });

        // --- Cargar Líneas/Polígonos desde Google Drive (KML/KMZ) - MÉTODO MÁS ROBUSTO ---
        const kmlData = [
            { name: "RUTA 1", url: 'https://drive.google.com/uc?export=download&id=1Ys6x-NI3FdsXKfuKtCxEtE3VdDNRFll0' },
            { name: "RUTA 2", url: 'https://drive.google.com/uc?export=download&id=13IIBzFYKQPhorU5BvZ0bN4VNEQ-KfsoS' }
        ];
        
        // Creamos el control de capas ANTES de llenarlo con los KML
        const layersControl = L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: false }).addTo(map);

        kmlData.forEach(item => {
            try {
                const kmlLayer = omnivore.kml(item.url)
                    .on('ready', function() {
                        this.addTo(map); // Añadir al mapa por defecto al cargar
                        layersControl.addOverlay(this, item.name); // Añadir al control de capas cuando esté lista
                        console.log(`Capa KML "${item.name}" cargada correctamente.`);
                    })
                    .on('error', function() {
                        console.error(`ERROR al cargar KML "${item.name}".`);
                        // Marcar la capa como errónea en el control de capas
                        const dummyLayer = L.layerGroup(); // Capa vacía para el control
                        layersControl.addOverlay(dummyLayer, `<span class="layer-error-label">${item.name}</span>`);
                    });
            } catch (e) {
                console.error(`Excepción al procesar KML "${item.name}":`, e);
                const dummyLayer = L.layerGroup();
                layersControl.addOverlay(dummyLayer, `<span class="layer-error-label">${item.name}</span>`);
            }
        });

        // 4. FUNCIONALIDAD DE LAS HERRAMIENTAS
        document.getElementById('buscador').addEventListener('keyup', function(e) {
            const textoBusqueda = e.target.value.toLowerCase().trim();
            layerGroupPuntos.clearLayers();
            const marcadoresFiltrados = todosLosMarcadores.filter(marcador => {
                return textoBusqueda === "" || Object.values(marcador.datos).some(valor => String(valor).toLowerCase().includes(textoBusqueda));
            });
            marcadoresFiltrados.forEach(marcador => layerGroupPuntos.addLayer(marcador));
        });

        document.getElementById('descargarKML').addEventListener('click', function() {
            let featureCollection = layerGroupPuntos.toGeoJSON();
            featureCollection.features.forEach((feature, index) => {
                let marcadorOriginal = layerGroupPuntos.getLayers()[index];
                if (marcadorOriginal && marcadorOriginal.datos) {
                    feature.properties = {
                        'name': marcadorOriginal.datos['Número de Cuenta'] || 'Sin cuenta',
                        'description': `<b>Número de Cuenta:</b> ${marcadorOriginal.datos['Número de Cuenta'] || ''}<br><b>Nomenclatura Castral:</b> ${marcadorOriginal.datos['Nomenclatura Castral'] || ''}<br><b>Nomenclatura Oficial:</b> ${marcadorOriginal.datos['Nomenclatura Oficial'] || ''}<br><b>Carpeta Interna:</b> ${marcadorOriginal.datos['Carpeta Interna'] || ''}<br><b>Observaciones:</b> ${marcadorOriginal.datos.observaciones || ''}`
                    };
                }
            });
            const kmlString = tokml(featureCollection, { name: 'name', description: 'description', documentName: 'Puntos Visibles Exportados' });
            const a = document.createElement('a');
            a.href = 'data:application/vnd.google-earth.kml+xml;charset=utf-8,' + encodeURIComponent(kmlString);
            a.download = 'puntos_visibles.kml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    </script>
</body>
</html>