<!DOCTYPE html>
<html>
<head>
    <!-- ... tu head sigue igual ... -->
    <style>
        /* ... tus estilos siguen igual ... */
    </style>
</head>
<body>
    <!-- ... tu body sigue igual ... -->

    <!-- SCRIPT PRINCIPAL DE LA APLICACIÓN -->
    <script type="module">
        // --- v3 - SOLUCIÓN PARA DUPLICADOS DE USUARIO ---
        // Si ves esta línea en el código fuente de tu navegador, estás usando la versión correcta.

        // --- CONFIGURACIÓN DE FIREBASE (MODULAR v9+) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // ... el resto del script es exactamente el mismo que te envié antes ...
        import { getDatabase, ref, onValue, set, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDCe3gLAbQsn1kBh-nRnKu8dXelIs_GmhY",
            authDomain: "visor-geografico-presencia.firebaseapp.com",
            databaseURL: "https://visor-geografico-presencia-default-rtdb.firebaseio.com",
            projectId: "visor-geografico-presencia",
            storageBucket: "visor-geografico-presencia.appspot.com",
            messagingSenderId: "761855239344",
            appId: "1:761855239344:web:1d5b9ce48d5997bb90c775",
            measurementId: "G-4HB0M8SCH3"
        };
        // ... resto del script ...
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        const connectedUsersRef = ref(database, 'connected_users');
        let currentUserPresenceRef = null;
        let mapInitialized = false;

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('visor-container').style.display = 'block';

                if (!mapInitialized) {
                    inicializarMapa();
                    mapInitialized = true;
                }
                gestionarPresenciaUsuario(user); 

            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('visor-container').style.display = 'none';
                if (currentUserPresenceRef) {
                    onDisconnect(currentUserPresenceRef).cancel();
                    currentUserPresenceRef = null;
                }
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorElement.textContent = "Email o contraseña incorrectos.";
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorElement = document.getElementById('register-error');
            errorElement.textContent = '';
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    errorElement.textContent = 'Este correo ya está registrado.';
                } else if (error.code === 'auth/weak-password') {
                    errorElement.textContent = 'La contraseña es demasiado débil.';
                } else {
                    errorElement.textContent = 'Error al registrar la cuenta.';
                }
            }
        });

        document.getElementById('logout-button').addEventListener('click', async () => {
            try {
                if (currentUserPresenceRef) {
                    await remove(currentUserPresenceRef);
                }
                await signOut(auth);
            } catch (error) {
                console.error("Error al cerrar sesión:", error.message);
                alert("Hubo un problema al cerrar la sesión.");
            }
        });
        
        document.getElementById('show-register').addEventListener('click', () => {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        });
        document.getElementById('show-login').addEventListener('click', () => {
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        });

        function gestionarPresenciaUsuario(user) {
            currentUserPresenceRef = ref(database, `connected_users/${user.uid}`);

            set(currentUserPresenceRef, {
                name: user.email,
                connected_at: serverTimestamp()
            });

            onDisconnect(currentUserPresenceRef).remove();

            onValue(connectedUsersRef, (snapshot) => {
                const usersListElement = document.getElementById('users-list');
                usersListElement.innerHTML = '';
                const users = snapshot.val();
                if (users) {
                    Object.values(users).forEach(user => {
                        const li = document.createElement('li');
                        li.textContent = user.name;
                        usersListElement.appendChild(li);
                    });
                } else {
                    usersListElement.innerHTML = '<li>Nadie más conectado.</li>';
                }
            });
        }

        function inicializarMapa() {
            // El resto de la función inicializarMapa es idéntica
        }
    </script>
</body>
</html>