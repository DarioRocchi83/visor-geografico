<!DOCTYPE html>
<html>
<head>
    <title>Visor Geográfico Profesional</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ESTILOS Y LIBRERÍAS (CSS y JavaScript) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.min.js"></script>

    <!-- Estilos personalizados -->
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-panel {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65); max-width: 270px;
        }
        .info-panel input, .info-panel button { width: 100%; box-sizing: border-box; margin-bottom: 5px; padding: 8px; }
        .info-panel button { background-color: #007bff; color: white; border: none; cursor: pointer; }
        .info-panel button:hover { background-color: #0056b3; }
        .info-panel .help-text { font-size: 0.8em; color: #555; margin-top: 5px; }
        .leaflet-top.leaflet-right { top: 10px; }
    </style>
</head>
<body>

    <div class="info-panel">
        <input type="text" id="buscador" placeholder="Buscar en todos los campos de los puntos...">
        <button id="descargarSeleccion">Descargar Selección (KML)</button>
        <p class="help-text">Haga clic en cualquier elemento del mapa para seleccionarlo/deseleccionarlo.</p>
    </div>

    <div id="map"></div>

    <script>
        // 1. INICIALIZACIÓN
        const baseMaps = {
            "Calles": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' }),
            "Satélite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © <a href="https://www.esri.com/">Esri</a>' }),
            "Híbrido": L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { pane: 'shadowPane' })
            ])
        };
        const map = L.map('map', { center: [-31.41, -64.18], zoom: 13, layers: [baseMaps.Calles] });
        map.createPane('shadowPane').style.zIndex = 650;
        
        const layersControl = L.control.layers(baseMaps, {}, { position: 'topright', collapsed: false }).addTo(map);
        L.control.measure({ position: 'topright', primaryLengthUnit: 'meters', localization: 'es' }).addTo(map);

        // 2. HERRAMIENTA DE SELECCIÓN
        const selectedLayer = L.featureGroup().addTo(map);
        const selectedStyle = { color: '#ffff00', weight: 5, opacity: 1 }; // Estilo amarillo brillante para selección

        function makeFeatureSelectable(layer) {
            layer.originalStyle = layer.options.style || layer.options; // Guardar estilo original
            layer.on('click', function(e) {
                if (selectedLayer.hasLayer(layer)) {
                    selectedLayer.removeLayer(layer);
                    if (layer.setStyle) layer.setStyle(layer.originalStyle); // Resetear estilo para polígonos/líneas
                } else {
                    selectedLayer.addLayer(layer);
                    if (layer.setStyle) layer.setStyle(selectedStyle); // Aplicar estilo de selección
                }
                L.DomEvent.stopPropagation(e);
            });
        }
        
        // 3. CARGA DE DATOS DINÁMICA
        const todosLosMarcadores = []; // Para la función de búsqueda
        
        // --- Carga de Puntos desde Google Sheets ---
        const sheetsData = [
            { name: "Cuentas Hoja 1", url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTkDyVDpow7TJAolEUXcWVW9I-5ntVxnJbTdVClWQpP5bPSkbXlfFdUjytdtWWqyUT1qXiM_a6T4u9Y/pub?gid=0&single=true&output=csv', color: '#007bff' },
            { name: "Cuentas Hoja 2", url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4fd4H6m1wrYei8KWqjCZEavtRrPph5Z1dXZkhC67pj_cCDk5WCrSUYAVPg59JNKvvQXrYK8b8u-Wj/pub?gid=0&single=true&output=csv', color: '#28a745' }
        ];

        function createColoredIcon(color, isSelected = false) {
            const fillColor = isSelected ? '#ffff00' : color;
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="${fillColor}" stroke="black" stroke-width="1.5" d="M16 0 C10.48 0 6 4.48 6 10 C6 16.5 16 32 16 32 S26 16.5 26 10 C26 4.48 21.52 0 16 0 Z"></path><circle cx="16" cy="10" r="4" fill="white"/></svg>`;
            return L.divIcon({ html: svg, className: '', iconSize: [28, 28], iconAnchor: [14, 28], popupAnchor: [0, -28] });
        }

        sheetsData.forEach(sheet => {
            const layerGroup = L.layerGroup().addTo(map);
            layersControl.addOverlay(layerGroup, sheet.name);
            Papa.parse(sheet.url, {
                download: true, header: true,
                complete: results => {
                    results.data.forEach(punto => {
                        if (punto.latitud && punto.longitud) {
                            const lat = parseFloat(String(punto.latitud).replace(',', '.'));
                            const lon = parseFloat(String(punto.longitud).replace(',', '.'));
                            const marker = L.marker([lat, lon], { icon: createColoredIcon(sheet.color) });
                            marker.datos = { ...punto, capa: sheet.name }; // Guardamos datos y nombre de la capa
                            marker.bindPopup(`<b>${sheet.name}</b><hr><b>N° Cuenta:</b> ${punto['Número de Cuenta'] || ''}<br><b>N. Catastral:</b> ${punto['Nomenclatura Castral'] || ''}`);
                            layerGroup.addLayer(marker);
                            todosLosMarcadores.push(marker);

                            // Lógica de selección para marcadores
                            marker.on('click', function(e) {
                                if (selectedLayer.hasLayer(marker)) {
                                    selectedLayer.removeLayer(marker);
                                    marker.setIcon(createColoredIcon(sheet.color, false));
                                } else {
                                    selectedLayer.addLayer(marker);
                                    marker.setIcon(createColoredIcon(sheet.color, true));
                                }
                                L.DomEvent.stopPropagation(e);
                            });
                        }
                    });
                }
            });
        });

        // --- Carga de KML desde Google Drive ---
        const kmlData = [
            { name: "RUTA 1", url: 'https://drive.google.com/uc?export=download&id=1Ys6x-NI3FdsXKfuKtCxEtE3VdDNRFll0', style: { color: 'blue', weight: 3 } },
            { name: "RUTA 2", url: 'https://drive.google.com/uc?export=download&id=13IIBzFYKQPhorU5BvZ0bN4VNEQ-KfsoS', style: { color: 'red', weight: 2 } }
        ];
        kmlData.forEach(item => {
            const kmlLayer = L.geoJson(null, { 
                style: feature => feature.properties.style || item.style,
                onEachFeature: (feature, layer) => makeFeatureSelectable(layer)
            }).addTo(map);
            layersControl.addOverlay(kmlLayer, item.name);
            omnivore.kml(item.url)
                .on('ready', function() { this.eachLayer(layer => kmlLayer.addLayer(layer)); })
                .on('error', () => console.error(`Error cargando KML: ${item.name}`));
        });

        // --- Carga de GeoJSON (Parcelas) desde Google Drive ---
        const urlParcelas = 'https://drive.google.com/uc?export=download&id=1Ccgvf3ebS1_A4FALqWbO29CdAHGiWx75';
        const estiloParcelas = { color: '#ff8c00', weight: 2, opacity: 0.9, fillColor: '#ffd700', fillOpacity: 0.4 };
        const parcelasLayer = L.geoJson(null, {
            style: estiloParcelas,
            onEachFeature: (feature, layer) => {
                let popupContent = '<h4>Datos de la Parcela</h4>';
                if (feature.properties) {
                    popupContent += '<div style="max-height: 200px; overflow-y: auto;"><table>';
                    for (const key in feature.properties) {
                        popupContent += `<tr><td style="padding-right:10px;"><strong>${key}</strong></td><td>${feature.properties[key]}</td></tr>`;
                    }
                    popupContent += '</table></div>';
                }
                layer.bindPopup(popupContent);
                makeFeatureSelectable(layer);
            }
        }).addTo(map);
        layersControl.addOverlay(parcelasLayer, "Parcelas");

        fetch(urlParcelas)
            .then(response => response.ok ? response.json() : Promise.reject('Error de red'))
            .then(data => {
                parcelasLayer.addData(data);
                map.fitBounds(parcelasLayer.getBounds());
            })
            .catch(error => console.error('FALLO AL CARGAR PARCELAS DESDE GOOGLE DRIVE:', error));

        // 4. FUNCIONALIDAD DE HERRAMIENTAS
        document.getElementById('buscador').addEventListener('input', function(e) {
            const texto = e.target.value.toLowerCase().trim();
            todosLosMarcadores.forEach(marker => {
                const esVisible = texto === "" || Object.values(marker.datos).some(val => String(val).toLowerCase().includes(texto));
                if (esVisible) {
                    if (!marker._map) marker.addTo(map); // Añadir si no está en el mapa
                } else {
                    if (marker._map) marker.remove(); // Quitar si está en el mapa
                }
            });
        });

        document.getElementById('descargarSeleccion').addEventListener('click', function() {
            if (selectedLayer.getLayers().length === 0) {
                alert("No hay elementos seleccionados. Haga clic en uno o más elementos en el mapa para seleccionarlos.");
                return;
            }
            const geojson = selectedLayer.toGeoJSON();

            // Enriquecer el KML con la información del popup
            geojson.features.forEach((feature, index) => {
                const layer = selectedLayer.getLayers()[index];
                feature.properties.name = layer.datos?.['Número de Cuenta'] || layer.feature?.properties?.name || 'Elemento Seleccionado';
                feature.properties.description = layer.getPopup()?.getContent() || 'Sin descripción.';
            });

            const kmlString = tokml(geojson, { name: 'name', description: 'description', documentName: 'Seleccion Exportada' });
            const a = document.createElement('a');
            a.href = 'data:application/vnd.google-earth.kml+xml;charset=utf-8,' + encodeURIComponent(kmlString);
            a.download = 'seleccion.kml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    </script>
</body>
</html>