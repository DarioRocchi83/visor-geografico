<!DOCTYPE html>
<html>
<head>
    <title>Visor Geográfico Mejorado</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ESTILOS Y LIBRERÍAS (CSS y JavaScript) -->

    <!-- 1. Leaflet (El motor del mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- 2. PapaParse (Para leer los puntos desde Google Sheets .csv) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- 3. Leaflet-Omnivore (Para leer polígonos/líneas desde KML/KMZ) -->
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

    <!-- 4. Leaflet.Measure (Para la herramienta de medir) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.js"></script>
    
    <!-- 5. tokml (Para exportar los datos a KML) -->
    <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.min.js"></script>

    <!-- Estilos personalizados para la página -->
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-panel {
            position: absolute;
            top: 10px;
            left: 50px; /* Leaflet pone sus controles a la izquierda, así que dejamos espacio */
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            max-width: 270px; /* Añadido para que no se haga muy ancho */
        }
        .info-panel input {
            width: 250px;
            padding: 5px;
            margin-bottom: 5px;
        }
        .info-panel button {
            width: 100%;
            padding: 8px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 5px;
        }
        .info-panel button:hover {
            background-color: #0056b3;
        }
        /* Estilo para el control de capas para que no se superponga con el panel de info */
        .leaflet-top.leaflet-right {
            top: 10px;
        }
    </style>
</head>
<body>

    <!-- HERRAMIENTAS DE LA INTERFAZ -->
    <div class="info-panel">
        <input type="text" id="buscador" placeholder="Buscar en todos los campos de los puntos...">
        <button id="descargarKML">Descargar Puntos Visibles (KML)</button>
    </div>

    <!-- EL MAPA -->
    <div id="map"></div>


    <!-- SCRIPT PRINCIPAL DE LA APLICACIÓN -->
    <script>
        // ==================================================================
        // 1. INICIALIZACIÓN DEL MAPA Y CAPAS BASE (MEJORA 3)
        // ==================================================================
        
        // Definimos las capas de mapa base que el usuario podrá elegir
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © <a href="https://www.esri.com/">Esri</a>'
        });
        
        var hibrido = L.layerGroup([
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '© <a href="https://carto.com/attributions">CARTO</a>',
                pane: 'shadowPane' // Asegura que las etiquetas se muestren por encima de la imagen satelital
            })
        ]);

        var baseMaps = {
            "Calles": osm,
            "Satélite": satelite,
            "Híbrido": hibrido
        };
        
        // Inicializamos el mapa
        var map = L.map('map', {
            center: [-32.88, -68.84], // Centrado en Mendoza, ajústalo a tu zona
            zoom: 13,
            layers: [osm] // Capa que se muestra por defecto al cargar
        });

        // Hacemos que el panel de etiquetas del mapa híbrido esté por encima
        map.createPane('shadowPane');
        map.getPane('shadowPane').style.zIndex = 650;


        // ==================================================================
        // 2. INICIALIZACIÓN DE HERRAMIENTAS
        // ==================================================================
        
        // Herramienta para medir distancias y áreas
        var measureControl = L.control.measure({
            position: 'topright',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares',
            activeColor: '#db4a39',
            completedColor: '#ff5e4d',
            localization: 'es' // Configurado en español
        });
        measureControl.addTo(map);


        // ==================================================================
        // 3. CARGA DE DATOS Y CONTROL DE CAPAS (MEJORA 1 y 2)
        // ==================================================================
        
        // Arrays y Grupos de Capas
        const todosLosMarcadores = []; // Contendrá TODOS los marcadores de los CSV
        const layerGroupPuntos = L.layerGroup().addTo(map); // Capa para los puntos, se añade al mapa por defecto
        
        // Objeto para las capas que se podrán activar/desactivar (Overlays)
        var overlayMaps = {
            "Puntos (Cuentas)": layerGroupPuntos
        };

        // --- Cargar Puntos desde Google Sheets (CSV) ---
        const urlsSheets = [
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vTkDyVDpow7TJAolEUXcWVW9I-5ntVxnJbTdVClWQpP5bPSkbXlfFdUjytdtWWqyUT1qXiM_a6T4u9Y/pub?gid=0&single=true&output=csv',
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4fd4H6m1wrYei8KWqjCZEavtRrPph5Z1dXZkhC67pj_cCDk5WCrSUYAVPg59JNKvvQXrYK8b8u-Wj/pub?gid=0&single=true&output=csv'
            // Puedes añadir más URLs de tus hojas de cálculo aquí
        ];

        urlsSheets.forEach(url => {
            Papa.parse(url, {
                download: true,
                header: true,
                complete: function(results) {
                    results.data.forEach(punto => {
                        if (punto.latitud && punto.longitud) {
                            const lat = parseFloat(String(punto.latitud).replace(',', '.'));
                            const lon = parseFloat(String(punto.longitud).replace(',', '.'));

                            const marker = L.marker([lat, lon]);
                            marker.datos = punto; 

                            let popupContent = `
                                <b>Número de Cuenta:</b> ${punto['Número de Cuenta'] || 'No disponible'}<br>
                                <b>Nomenclatura Castral:</b> ${punto['Nomenclatura Castral'] || 'No disponible'}<br>
                                <b>Nomenclatura Oficial:</b> ${punto['Nomenclatura Oficial'] || 'No disponible'}<br>
                                <b>Carpeta Interna:</b> ${punto['Carpeta Interna'] || 'No disponible'}<br>
                                <b>Observaciones:</b> ${punto.observaciones || 'No disponible'}
                            `;
                            marker.bindPopup(popupContent);
                            
                            todosLosMarcadores.push(marker);
                            layerGroupPuntos.addLayer(marker);
                        }
                    });
                }
            });
        });

        // --- Cargar Líneas/Polígonos desde Google Drive (KML/KMZ) ---
        // ¡IMPORTANTE! PARA QUE ESTO FUNCIONE, CADA ARCHIVO EN GOOGLE DRIVE DEBE ESTAR
        // COMPARTIDO COMO "CUALQUIER PERSONA CON EL ENLACE PUEDE VER".
        const kmlData = [
            { name: "Polígonos KML 1", url: 'https://drive.google.com/uc?export=download&id=1Ys6x-NI3FdsXKfuKtCxEtE3VdDNRFll0' },
            { name: "Líneas KML 2", url: 'https://drive.google.com/uc?export=download&id=13IIBzFYKQPhorU5BvZ0bN4VNEQ-KfsoS' }
            // Puedes añadir más KML/KMZ aquí, dándoles un nombre para el menú de capas
        ];

        kmlData.forEach(item => {
            // Creamos una capa para este KML específico
            const kmlLayer = omnivore.kml(item.url)
                .on('ready', function() {
                    // Cuando la capa está lista, la añadimos al mapa
                    this.addTo(map);
                    console.log(`Capa KML "${item.name}" cargada correctamente.`);
                })
                .on('error', function() {
                    // Si hay un error (muy común con Google Drive si no está bien compartido)
                    console.error(`ERROR: No se pudo cargar la capa KML "${item.name}". Verifica que el enlace sea correcto y que el archivo esté compartido públicamente.`);
                    alert(`ERROR: No se pudo cargar la capa KML "${item.name}". \n\nPor favor, verifica en Google Drive que el archivo esté compartido con la opción "Cualquier persona con el enlace".`);
                });

            // Añadimos la capa al control de capas para poder activarla/desactivarla
            overlayMaps[item.name] = kmlLayer;
        });

        // AÑADIMOS EL CONTROL DE CAPAS AL MAPA
        L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: false }).addTo(map);


        // ==================================================================
        // 4. FUNCIONALIDAD DE LAS HERRAMIENTAS (MEJORA 4)
        // ==================================================================

        // --- Lógica del Buscador (Mejorada) ---
        document.getElementById('buscador').addEventListener('keyup', function(e) {
            const textoBusqueda = e.target.value.toLowerCase().trim();
            
            layerGroupPuntos.clearLayers();

            if (textoBusqueda === "") {
                // Si no hay búsqueda, mostramos todos los marcadores
                todosLosMarcadores.forEach(marcador => layerGroupPuntos.addLayer(marcador));
                return;
            }

            const marcadoresFiltrados = todosLosMarcadores.filter(marcador => {
                // Iteramos sobre todos los valores de los datos del marcador
                // y comprobamos si alguno contiene el texto de búsqueda.
                return Object.values(marcador.datos).some(valor => 
                    String(valor).toLowerCase().includes(textoBusqueda)
                );
            });

            marcadoresFiltrados.forEach(marcador => {
                layerGroupPuntos.addLayer(marcador);
            });
        });

        // --- Lógica para Descargar KML ---
        document.getElementById('descargarKML').addEventListener('click', function() {
            let featureCollection = layerGroupPuntos.toGeoJSON();

            featureCollection.features.forEach((feature, index) => {
                let marcadorOriginal = layerGroupPuntos.getLayers()[index];
                if (marcadorOriginal && marcadorOriginal.datos) {
                    feature.properties = {
                        'name': marcadorOriginal.datos['Número de Cuenta'] || 'Sin cuenta',
                        'description': `
                            <b>Número de Cuenta:</b> ${marcadorOriginal.datos['Número de Cuenta'] || ''}<br>
                            <b>Nomenclatura Castral:</b> ${marcadorOriginal.datos['Nomenclatura Castral'] || ''}<br>
                            <b>Nomenclatura Oficial:</b> ${marcadorOriginal.datos['Nomenclatura Oficial'] || ''}<br>
                            <b>Carpeta Interna:</b> ${marcadorOriginal.datos['Carpeta Interna'] || ''}<br>
                            <b>Observaciones:</b> ${marcadorOriginal.datos.observaciones || ''}
                        `
                    };
                }
            });
            
            const kmlString = tokml(featureCollection, {
                name: 'name',
                description: 'description',
                documentName: 'Puntos Visibles Exportados',
                documentDescription: 'Puntos exportados desde el Visor Geográfico'
            });

            const a = document.createElement('a');
            a.href = 'data:application/vnd.google-earth.kml+xml;charset=utf-8,' + encodeURIComponent(kmlString);
            a.download = 'puntos_visibles.kml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

    </script>

</body>
</html>
